# Device Management API Documentation

## Table of Contents
1. [Overview](#overview)
2. [Authentication](#authentication)
3. [Base URL](#base-url)
4. [Root User Endpoints](#root-user-endpoints)
5. [Orchard Admin Endpoints](#orchard-admin-endpoints)
6. [Mobile App Endpoints](#mobile-app-endpoints)
7. [Data Models](#data-models)
8. [Error Handling](#error-handling)
9. [Workflows](#workflows)

---

## Overview

The Device Management API allows you to manage tracking devices for workers and tractors. The system supports three types of devices:

- **Mobile Phone**: Worker's mobile phone with device fingerprint
- **Personal GPS**: Standalone GPS device for workers
- **Tractor GPS**: GPS device attached to tractors

### Key Concepts

- **Root User**: Can register, approve, and manage all devices
- **Orchard Admin**: Can assign approved devices to workers in their farm
- **Device Fingerprint**: Unique identifier generated by mobile app on first launch
- **Connection Request**: Mobile phones must request approval before being used

---

## Authentication

### Authenticated Endpoints

Most endpoints require authentication using Laravel Sanctum. Include the bearer token in the Authorization header:

```http
Authorization: Bearer {your-token}
```

### Roles

- **root**: Full access to all device management features
- **admin**: Can assign devices to workers in their assigned farms

### Mobile App Endpoints

Mobile app endpoints (`/api/mobile/*`) do **not** require authentication. They use device fingerprint validation instead.

---

## Base URL

```
https://your-domain.com/api
```

---

## Root User Endpoints

### List All Devices

Get a paginated list of all devices (tractor and worker devices).

**Endpoint:** `GET /api/devices`

**Authentication:** Required (Root only)

**Query Parameters:**
- `type` (optional): Filter by device type
  - `tractor` - Only tractor GPS devices
  - `worker` - Only worker devices (mobile_phone, personal_gps)
- `page` (optional): Page number for pagination

**Response:** `200 OK`

```json
{
  "data": [
    {
      "id": 1,
      "device_type": "mobile_phone",
      "name": "Mobile Phone - 09123456789",
      "imei": null,
      "sim_number": null,
      "device_fingerprint": "abc123...",
      "mobile_number": "09123456789",
      "is_active": true,
      "approved_at": "2026-01-03 10:30:00",
      "user": {
        "id": 1,
        "username": "admin",
        "mobile": "09120000000"
      },
      "farm": {
        "id": 1,
        "name": "Main Orchard"
      },
      "labour": {
        "id": 5,
        "name": "John Doe",
        "mobile": "09123456789"
      },
      "approver": {
        "id": 1,
        "username": "admin"
      },
      "created_at": "2026-01-03 10:00:00",
      "can": {
        "update": true,
        "delete": true
      }
    }
  ],
  "links": {
    "first": "http://example.com/api/devices?page=1",
    "last": "http://example.com/api/devices?page=10",
    "prev": null,
    "next": "http://example.com/api/devices?page=2"
  },
  "meta": {
    "current_page": 1,
    "from": 1,
    "last_page": 10,
    "per_page": 15,
    "to": 15,
    "total": 150
  }
}
```

**Example Request:**
```javascript
fetch('/api/devices?type=worker', {
  headers: {
    'Authorization': 'Bearer ' + token,
    'Accept': 'application/json'
  }
})
```

---

### Create Personal GPS Device

Create a new Personal GPS or Tractor GPS device directly (no approval needed).

**Endpoint:** `POST /api/devices`

**Authentication:** Required (Root only)

**Request Body:**
```json
{
  "device_type": "personal_gps",
  "name": "GPS Device #1",
  "imei": "123456789012345",
  "sim_number": "09123456789",
  "farm_id": 1
}
```

**For Tractor GPS:**
```json
{
  "device_type": "tractor_gps",
  "name": "Tractor GPS #1",
  "imei": "123456789012345",
  "sim_number": "09123456789",
  "tractor_id": 5
}
```

**Validation Rules:**
- `device_type`: Required, must be `personal_gps` or `tractor_gps`
- `name`: Required, string, max 255 characters
- `imei`: Required, string, max 255 characters, unique
- `sim_number`: Optional, string, max 255 characters, unique
- `tractor_id`: Required if `device_type` is `tractor_gps`, must exist in tractors table
- `farm_id`: Optional, must exist in farms table

**Response:** `201 Created`

```json
{
  "data": {
    "id": 2,
    "device_type": "personal_gps",
    "name": "GPS Device #1",
    "imei": "123456789012345",
    "sim_number": "09123456789",
    "device_fingerprint": null,
    "mobile_number": null,
    "is_active": true,
    "approved_at": "2026-01-03 11:00:00",
    "farm": {
      "id": 1,
      "name": "Main Orchard"
    },
    "created_at": "2026-01-03 11:00:00"
  }
}
```

**Error Response:** `422 Unprocessable Entity`
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "imei": ["The imei has already been taken."]
  }
}
```

---

### Get Device Details

Get detailed information about a specific device.

**Endpoint:** `GET /api/devices/{id}`

**Authentication:** Required (Root only)

**Response:** `200 OK`

```json
{
  "data": {
    "id": 1,
    "device_type": "mobile_phone",
    "name": "Mobile Phone - 09123456789",
    "imei": null,
    "sim_number": null,
    "device_fingerprint": "abc123...",
    "mobile_number": "09123456789",
    "is_active": true,
    "approved_at": "2026-01-03 10:30:00",
    "user": {
      "id": 1,
      "username": "admin",
      "mobile": "09120000000"
    },
    "farm": {
      "id": 1,
      "name": "Main Orchard"
    },
    "labour": {
      "id": 5,
      "name": "John Doe",
      "mobile": "09123456789"
    },
    "approver": {
      "id": 1,
      "username": "admin"
    },
    "created_at": "2026-01-03 10:00:00",
    "can": {
      "update": true,
      "delete": true
    }
  }
}
```

---

### Update Device

Update device information (change allocation, deactivate, etc.).

**Endpoint:** `PUT /api/devices/{id}`

**Authentication:** Required (Root only)

**Request Body:**
```json
{
  "name": "Updated Device Name",
  "farm_id": 2,
  "is_active": false
}
```

**Validation Rules:**
- `name`: Optional, string, max 255 characters
- `imei`: Optional, string, max 255 characters, unique (except current device)
- `sim_number`: Optional, string, max 255 characters, unique (except current device)
- `farm_id`: Optional, must exist in farms table
- `is_active`: Optional, boolean

**Response:** `200 OK`

```json
{
  "data": {
    "id": 1,
    "name": "Updated Device Name",
    "farm_id": 2,
    "is_active": false,
    ...
  }
}
```

---

### Delete Device

Delete a device permanently.

**Endpoint:** `DELETE /api/devices/{id}`

**Authentication:** Required (Root only)

**Response:** `204 No Content`

---

### List Connection Requests

Get a list of pending mobile phone connection requests.

**Endpoint:** `GET /api/device-connection-requests`

**Authentication:** Required (Root only)

**Query Parameters:**
- `status` (optional): Filter by status (`pending`, `approved`, `rejected`)
- `page` (optional): Page number for pagination

**Response:** `200 OK`

```json
{
  "data": [
    {
      "id": 1,
      "mobile_number": "09123456789",
      "device_fingerprint": "abc123...",
      "device_info": {
        "model": "iPhone 13",
        "os_version": "15.0",
        "app_version": "1.0.0"
      },
      "status": "pending",
      "rejected_reason": null,
      "farm": null,
      "approver": null,
      "approved_at": null,
      "created_at": "2026-01-03 09:00:00"
    }
  ],
  "links": {...},
  "meta": {...}
}
```

---

### Approve Connection Request

Approve a mobile phone connection request and allocate it to a farm.

**Endpoint:** `POST /api/device-connection-requests/{id}/approve`

**Authentication:** Required (Root only)

**Request Body:**
```json
{
  "farm_id": 1
}
```

**Validation Rules:**
- `farm_id`: Required, must exist in farms table

**Response:** `200 OK`

```json
{
  "data": {
    "id": 1,
    "mobile_number": "09123456789",
    "device_fingerprint": "abc123...",
    "status": "approved",
    "farm": {
      "id": 1,
      "name": "Main Orchard"
    },
    "approver": {
      "id": 1,
      "username": "admin"
    },
    "approved_at": "2026-01-03 10:30:00",
    "created_at": "2026-01-03 09:00:00"
  }
}
```

**Note:** This action automatically creates a `GpsDevice` record with `device_type: 'mobile_phone'`.

---

### Reject Connection Request

Reject a mobile phone connection request.

**Endpoint:** `POST /api/device-connection-requests/{id}/reject`

**Authentication:** Required (Root only)

**Request Body:**
```json
{
  "rejected_reason": "Invalid device information"
}
```

**Validation Rules:**
- `rejected_reason`: Optional, string, max 500 characters

**Response:** `200 OK`

```json
{
  "data": {
    "id": 1,
    "status": "rejected",
    "rejected_reason": "Invalid device information",
    "approver": {
      "id": 1,
      "username": "admin"
    },
    "approved_at": "2026-01-03 10:30:00",
    ...
  }
}
```

---

## Orchard Admin Endpoints

### List Worker Devices for Farm

Get a list of worker devices allocated to the orchard admin's farm.

**Endpoint:** `GET /api/farms/{farmId}/worker-devices`

**Authentication:** Required (Orchard Admin only)

**Response:** `200 OK`

```json
{
  "data": [
    {
      "id": 1,
      "device_type": "mobile_phone",
      "name": "Mobile Phone - 09123456789",
      "mobile_number": "09123456789",
      "imei": null,
      "is_active": true,
      "labour": {
        "id": 5,
        "name": "John Doe",
        "mobile": "09123456789"
      },
      "labour": null,
      "approver": {
        "id": 1,
        "username": "admin"
      },
      "approved_at": "2026-01-03 10:30:00",
      "created_at": "2026-01-03 10:00:00"
    }
  ],
  "links": {...},
  "meta": {...}
}
```

**Error Response:** `403 Forbidden`
```json
{
  "message": "You do not have access to this farm"
}
```

---

### Assign Device to Worker

Assign a device to a worker. If the worker already has a device, the old device will be automatically deactivated.

**Endpoint:** `PUT /api/worker-devices/{deviceId}/assign`

**Authentication:** Required (Orchard Admin only)

**Request Body:**
```json
{
  "labour_id": 5
}
```

**Validation Rules:**
- `labour_id`: Required, must exist in labours table and belong to the same farm as the device

**Response:** `200 OK`

```json
{
  "data": {
    "id": 1,
    "device_type": "mobile_phone",
    "labour": {
      "id": 5,
      "name": "John Doe",
      "mobile": "09123456789"
    },
    ...
  }
}
```

**Error Responses:**

`403 Forbidden` - Device or labour doesn't belong to admin's farm:
```json
{
  "message": "You do not have access to this device"
}
```

`403 Forbidden` - Labour belongs to different farm:
```json
{
  "message": "Labour must belong to the same farm as the device"
}
```

---

### Unassign Device from Worker

Remove device assignment from a worker.

**Endpoint:** `PUT /api/worker-devices/{deviceId}/unassign`

**Authentication:** Required (Orchard Admin only)

**Response:** `200 OK`

```json
{
  "data": {
    "id": 1,
    "labour": null,
    ...
  }
}
```

---

## Mobile App Endpoints

### Create Connection Request

Submit a connection request from the mobile app. This endpoint does not require authentication.

**Endpoint:** `POST /api/mobile/connect`

**Authentication:** Not required

**Request Body:**
```json
{
  "mobile_number": "09123456789",
  "device_fingerprint": "abc123def456...",
  "device_info": {
    "model": "iPhone 13",
    "os_version": "15.0",
    "app_version": "1.0.0"
  }
}
```

**Validation Rules:**
- `mobile_number`: Required, string, max 20 characters
- `device_fingerprint`: Required, string, max 255 characters
- `device_info`: Optional, object
  - `model`: Optional, string
  - `os_version`: Optional, string
  - `app_version`: Optional, string

**Response Scenarios:**

**1. New Request Created:** `200 OK`
```json
{
  "data": {
    "status": "requested",
    "message": "Connection request submitted successfully",
    "request_id": 1
  }
}
```

**2. Already Connected:** `200 OK`
```json
{
  "data": {
    "status": "connected",
    "message": "Device is already connected and approved",
    "device_id": 5
  }
}
```

**3. Request Pending:** `200 OK`
```json
{
  "data": {
    "status": "pending",
    "message": "Connection request is pending approval",
    "request_id": 1
  }
}
```

**Error Response:** `422 Unprocessable Entity`
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "device_fingerprint": ["The device fingerprint field is required."]
  }
}
```

---

### Submit GPS Data

Submit GPS tracking data from the mobile app. This endpoint validates the device fingerprint instead of user authentication.

**Endpoint:** `POST /api/mobile/gps`

**Authentication:** Not required (uses device fingerprint validation)

**Request Body:**
```json
{
  "device_fingerprint": "abc123def456...",
  "mobile_number": "09123456789",
  "latitude": 35.6895,
  "longitude": 51.3895,
  "altitude": 1200.5,
  "speed": 5.5,
  "time": 1731632212000,
  "status": 1
}
```

**Validation Rules:**
- `device_fingerprint`: Required, string, max 255 characters
- `mobile_number`: Optional, string, max 20 characters
- `imei`: Optional, string, max 255 characters
- `latitude`: Required, numeric, between -90 and 90
- `longitude`: Required, numeric, between -180 and 180
- `altitude`: Optional, numeric
- `speed`: Optional, numeric, min 0
- `time`: Required, integer (timestamp in milliseconds)
- `status`: Optional, integer, must be 0 (stop) or 1 (movement)

**Response:** `200 OK`
```json
{
  "success": true
}
```

**Error Responses:**

`401 Unauthorized` - Device not approved or inactive:
```json
{
  "error": "Device not approved or inactive"
}
```

`404 Not Found` - Device not assigned to worker:
```json
{
  "error": "Device not assigned to a worker"
}
```

`422 Unprocessable Entity` - Invalid GPS data:
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "latitude": ["The latitude must be between -90 and 90."]
  }
}
```

---

## Data Models

### Device

```typescript
interface Device {
  id: number;
  device_type: 'mobile_phone' | 'personal_gps' | 'tractor_gps';
  name: string;
  imei: string | null;
  sim_number: string | null;
  device_fingerprint: string | null;
  mobile_number: string | null;
  is_active: boolean;
  approved_at: string | null; // Format: "Y-m-d H:i:s"
  user?: {
    id: number;
    username: string;
    mobile: string;
  };
  farm?: {
    id: number;
    name: string;
  };
  tractor?: {
    id: number;
    name: string;
  };
  labour?: {
    id: number;
    name: string;
    mobile: string;
  };
  approver?: {
    id: number;
    username: string;
  };
  created_at: string; // Format: "Y-m-d H:i:s"
  can: {
    update: boolean;
    delete: boolean;
  };
}
```

### Device Connection Request

```typescript
interface DeviceConnectionRequest {
  id: number;
  mobile_number: string;
  device_fingerprint: string;
  device_info: {
    model?: string;
    os_version?: string;
    app_version?: string;
  } | null;
  status: 'pending' | 'approved' | 'rejected';
  rejected_reason: string | null;
  farm?: {
    id: number;
    name: string;
  } | null;
  approver?: {
    id: number;
    username: string;
  } | null;
  approved_at: string | null; // Format: "Y-m-d H:i:s"
  created_at: string; // Format: "Y-m-d H:i:s"
}
```

### Worker Device

```typescript
interface WorkerDevice {
  id: number;
  device_type: 'mobile_phone' | 'personal_gps';
  name: string;
  mobile_number: string | null;
  imei: string | null;
  is_active: boolean;
  labour?: {
    id: number;
    name: string;
    mobile: string;
  } | null;
  approver?: {
    id: number;
    username: string;
  };
  approved_at: string | null; // Format: "Y-m-d H:i:s"
  created_at: string; // Format: "Y-m-d H:i:s"
}
```

---

## Error Handling

### Standard Error Response Format

```json
{
  "message": "Error message",
  "errors": {
    "field_name": ["Error message for this field"]
  }
}
```

### HTTP Status Codes

- `200 OK` - Request successful
- `201 Created` - Resource created successfully
- `204 No Content` - Resource deleted successfully
- `400 Bad Request` - Invalid request
- `401 Unauthorized` - Authentication required or invalid
- `403 Forbidden` - Insufficient permissions
- `404 Not Found` - Resource not found
- `422 Unprocessable Entity` - Validation errors
- `500 Internal Server Error` - Server error

### Common Error Scenarios

**Authentication Error:**
```json
{
  "message": "Unauthenticated."
}
```

**Authorization Error:**
```json
{
  "message": "This action is unauthorized."
}
```

**Validation Error:**
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "imei": ["The imei has already been taken."],
    "farm_id": ["The selected farm id is invalid."]
  }
}
```

---

## Workflows

### Workflow 1: Mobile Phone Connection

1. **Mobile App**: User installs app and logs in with mobile number
2. **Mobile App**: Generates device fingerprint on first launch
3. **Mobile App**: Calls `POST /api/mobile/connect` with fingerprint and mobile number
4. **Backend**: Creates connection request with status `pending`
5. **Root User**: Views pending requests via `GET /api/device-connection-requests`
6. **Root User**: Approves request via `POST /api/device-connection-requests/{id}/approve` with `farm_id`
7. **Backend**: Creates `GpsDevice` with `device_type: 'mobile_phone'` and allocates to farm
8. **Orchard Admin**: Views devices for their farm via `GET /api/farms/{farmId}/worker-devices`
9. **Orchard Admin**: Assigns device to worker via `PUT /api/worker-devices/{deviceId}/assign`
10. **Mobile App**: Can now submit GPS data via `POST /api/mobile/gps`

### Workflow 2: Personal GPS Device Registration

1. **Root User**: Creates device via `POST /api/devices` with `device_type: 'personal_gps'`
2. **Backend**: Device is automatically approved and allocated to farm (if `farm_id` provided)
3. **Orchard Admin**: Views devices and assigns to worker
4. **Device**: Can send GPS data (if device supports API integration)

### Workflow 3: Device Replacement

1. **Orchard Admin**: Assigns new device to worker via `PUT /api/worker-devices/{newDeviceId}/assign`
2. **Backend**: Automatically deactivates old device and assigns new one
3. **Mobile App**: Old device fingerprint is no longer valid
4. **Mobile App**: New device must go through connection request process if it's a mobile phone

---

## Example Code

### JavaScript/TypeScript Examples

#### List Devices with Filtering

```typescript
async function getWorkerDevices(token: string) {
  const response = await fetch('/api/devices?type=worker', {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/json'
    }
  });
  
  if (!response.ok) {
    throw new Error('Failed to fetch devices');
  }
  
  return await response.json();
}
```

#### Create Personal GPS Device

```typescript
async function createPersonalGpsDevice(
  token: string,
  deviceData: {
    name: string;
    imei: string;
    sim_number?: string;
    farm_id?: number;
  }
) {
  const response = await fetch('/api/devices', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      device_type: 'personal_gps',
      ...deviceData
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Failed to create device');
  }
  
  return await response.json();
}
```

#### Approve Connection Request

```typescript
async function approveConnectionRequest(
  token: string,
  requestId: number,
  farmId: number
) {
  const response = await fetch(
    `/api/device-connection-requests/${requestId}/approve`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ farm_id: farmId })
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Failed to approve request');
  }
  
  return await response.json();
}
```

#### Assign Device to Worker

```typescript
async function assignDeviceToWorker(
  token: string,
  deviceId: number,
  labourId: number
) {
  const response = await fetch(`/api/worker-devices/${deviceId}/assign`, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ labour_id: labourId })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Failed to assign device');
  }
  
  return await response.json();
}
```

#### Mobile App: Submit Connection Request

```typescript
async function submitConnectionRequest(
  mobileNumber: string,
  deviceFingerprint: string,
  deviceInfo?: {
    model?: string;
    os_version?: string;
    app_version?: string;
  }
) {
  const response = await fetch('/api/mobile/connect', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      mobile_number: mobileNumber,
      device_fingerprint: deviceFingerprint,
      device_info: deviceInfo
    })
  });
  
  const data = await response.json();
  
  if (data.data.status === 'connected') {
    // Device already approved, can start sending GPS data
    return { connected: true, deviceId: data.data.device_id };
  } else if (data.data.status === 'pending') {
    // Request submitted, waiting for approval
    return { pending: true, requestId: data.data.request_id };
  } else {
    // New request created
    return { requested: true, requestId: data.data.request_id };
  }
}
```

#### Mobile App: Submit GPS Data

```typescript
async function submitGpsData(
  deviceFingerprint: string,
  gpsData: {
    latitude: number;
    longitude: number;
    altitude?: number;
    speed?: number;
    time: number; // timestamp in milliseconds
    status?: 0 | 1; // 0 = stop, 1 = movement
  }
) {
  const response = await fetch('/api/mobile/gps', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      device_fingerprint: deviceFingerprint,
      ...gpsData
    })
  });
  
  if (response.status === 401) {
    const error = await response.json();
    throw new Error(error.error || 'Device not authorized');
  }
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Failed to submit GPS data');
  }
  
  return await response.json();
}
```

---

## Best Practices

1. **Error Handling**: Always check response status and handle errors gracefully
2. **Pagination**: Use pagination links for large datasets
3. **Caching**: Cache device lists and connection requests appropriately
4. **Retry Logic**: Implement retry logic for mobile app GPS submissions
5. **Rate Limiting**: Be aware of rate limits on mobile endpoints
6. **Device Fingerprint**: Store device fingerprint securely in mobile app
7. **Status Polling**: Poll connection request status periodically in mobile app
8. **Offline Support**: Queue GPS data submissions when offline

---

## Support

For API support or questions, please contact the development team.

**Last Updated:** January 3, 2026

